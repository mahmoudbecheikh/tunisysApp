<app-sidebar></app-sidebar>

<div class="container">


    <div (click)="rapport()" *ngIf="employe?.role==2" class="btn btn-primary">
        Rapport
    </div>
    <!-- <select class="form-control" [formControl]="employeCtrl">
        <option value="" disabled hidden selected>Sélectionnez un departement</option>
        <ng-container *ngFor="let emp of employes">
            <option *ngIf="employe?._id!=emp._id" [disabled]="verify(emp?._id)" value="{{emp._id}}">{{emp.nomEmp}}
                <span>(Deja envoyee)</span> </option>
        </ng-container>
    </select> -->

    <div class="btn-group">
        <button type="button" class="btn btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
            aria-expanded="false">
            Inviter
        </button>
        <div class="dropdown-menu">
            <ng-container *ngFor="let emp of employes">

                <div *ngIf="(employe?._id!=emp._id) && !this.ticket?.collaborateurs?.includes(emp._id)" class="dropdown-item">
                    {{emp.nomEmp}}
   
                    <div class="badge badge-secondary" *ngIf="!verify(emp?._id);else annuler"
                        (click)="envoyerNotif(emp._id)">Envoyer</div>
                    <ng-template #annuler>
                        <div class="badge badge-secondary" (click)="supprimer(emp._id)">Annuler</div>
                    </ng-template>
                </div>
            </ng-container>



        </div>
    </div>
    <!-- 

    <div (click)="envoyerNotif()" *ngIf="employe?.role==2" class="btn btn-primary">
        Envoyer
    </div> -->



    <div class="row">
        <div class="col-sm">
            <h1>{{ticket?.sujet}}</h1>

            <div class="row">
                <div class="info col-sm">
                    <p>Référence : <span>{{ticket?.ref}}</span></p>
                    <p>Nom : <span>{{ticket?.nomClient}}</span></p>
                    <p>Email : <span>{{ticket?.emailClient}}</span></p>
                    <p>Tel : <span>{{ticket?.telClient}}</span></p>
                    <p>Adresse : <span>{{ticket?.adresse}}</span></p>
                    <p>Site : <span>{{ticket?.siteWeb}}</span></p>

                </div>
                <div class="info col-sm">
                    <p>Département : <span>{{ticket?.departement?.nom}}</span></p>
                    <p>Employe : <span *ngIf="ticket?.employe">{{ticket?.employe?.nomEmp}}</span>
                        <span *ngIf="!ticket?.employe">---</span>
                    </p>

                    <p>Manuel : <span>{{ticket?.manuel}}</span> </p>
                    <p>Statut :
                        <span class="badge bg-secondary" *ngIf="ticket?.statut=='en attente'">{{ ticket?.statut}}</span>
                        <span class="badge bg-warning" *ngIf="ticket?.statut=='a faire'">{{ ticket?.statut }}</span>
                        <span class="badge bg-primary" *ngIf="ticket?.statut=='en cours'">{{ ticket?.statut }}</span>
                        <span class="badge bg-success" *ngIf="ticket?.statut=='resolu'">{{ ticket?.statut }}</span>
                    </p>
                    <p>Date : <span> {{ ticket?.date | date: 'dd/MM/yyyy HH:mm:ss'}}</span></p>
                    <p>Modifié: <span> {{ ticket?.dateModif | date: 'dd/MM/yyyy HH:mm:ss'}}</span></p>

                </div>
            </div>


        </div>
    </div>

    <div class="row" *ngIf="ticket?.feedBack">
        <h3 style="margin-top: 5px; margin-bottom: 5px;">
            Évaluation
        </h3>
        <div>
            <i class="lni lni-star-filled" *ngFor="let item of [].constructor(5); let index = index;"
                [ngStyle]="{'color':index<ticket?.feedBack?.note?'red':'' }" style="margin-bottom: 20px;"></i>
            <p>
                {{ticket?.feedBack?.commentaire}}
            </p>
        </div>
        <br>

    </div>


    <div class="row">
        <div class="col-sm">
            <h3>Description</h3>
            <div class="row">
                <div class="col-sm desc">
                    <textarea style="word-wrap: break-word;" class="form-control" id="exampleFormControlTextarea1"
                        disabled rows="8">{{ticket?.description}}
                    </textarea>
                </div>
            </div>
        </div>

        <div class="col-sm text-center">
            <h3>Pièce jointe</h3>

            <div style="margin: 10px;" class="row files" *ngIf="files && files.length>0;else vide">
                <div class="col-sm-2 file" *ngFor="let file of files" (click)='download(file)'>
                    <img src="../../../../assets/images/file.png">
                    <p>{{file}}</p>
                </div>
            </div>
            <ng-template #vide>
                <p> Il n'y a aucune pièce jointe
                </p>
            </ng-template>
        </div>
    </div>

    <div class="row">

        <div class="col-sm">
            <h3>Messages</h3>

            <table class="table">
                <tbody>
                    <tr *ngFor="let mail of mails">
                        <th scope="row" *ngIf="mail.from=='tunisys.mb.sj@gmail.com';else tuni">Tunisys
                        </th>
                        <ng-template #tuni>
                            <th>{{mail.name}}</th>
                        </ng-template>
                        <td>
                            {{mail.subject}}
                            <p style="word-wrap: break-word;  word-break: break-all;
                            " [innerHtml]="mail.body"></p>
                        </td>
                        <td>
                            <p>{{mail.date | date: 'dd/MM/yyyy HH:mm:ss'}}</p>
                        </td>
                    </tr>

                </tbody>
            </table>
        </div>

        <div class="col-sm">
            <h3 style="text-align: center;">Nouveau message</h3>
            <form [formGroup]="myForm" (ngSubmit)="envoyer()">
                <input type="text" class="form-control" name="email" id="email" formControlName="email"
                    placeholder="Destinataire">
                <input type="text" class="form-control" name="sujet" id="sujet" formControlName="sujet"
                    placeholder="Objet">
                <div class="form-group">
                    <textarea class="form-control" formControlName="text" id="desc"
                        placeholder="Rédigez votre rapport de résolution" rows="7"></textarea>
                    <div style="margin: 5px; background: #f5f5f5" *ngFor="let file of attachements">
                        <p style="color: #0066FF;">{{file}}</p>
                    </div>
                </div>

                <input type="file" name="file" id="file" multiple (change)="uploadMultiple($event)"
                    style="visibility: hidden;display: none;">
                <input class="btn btn-primary" type="submit" [disabled]="myForm.invalid" />
                <i class="lni lni-trash-can"></i>
                <label for="file"> <i class="lni lni-paperclip"></i></label>

            </form>
        </div>
    </div>



    <form [formGroup]="formTag" *ngIf="employe?.role==2" style="width: 50%;" (ngSubmit)="enregistrer()">

        <span *ngFor="let fruit of filtredTags" class="badge badge-light" (click)="selected(fruit)">{{fruit}}</span>

        <mat-form-field class="example-chip-list" appearance="fill">
            <mat-label>Ajouter tag</mat-label>
            <mat-chip-list #chipList aria-label="Fruit selection">
                <mat-chip *ngFor="let tag of tags" (removed)="remove(tag)">
                    {{tag}}
                    <button matChipRemove>
                        <i class="lni lni-close"></i>
                    </button>
                </mat-chip>
                <input placeholder="Nouveau ..." #tagInput [formControl]="tagsCtrl" [matChipInputFor]="chipList"
                    [matChipInputSeparatorKeyCodes]="separatorKeysCodes" (matChipInputTokenEnd)="add($event)">
            </mat-chip-list>

        </mat-form-field>
        <input class="btn btn-primary" [disabled]="formTag.invalid" value="Enregistrer" type="submit" />


    </form>


</div>